// ================================================================
// KODE BACKEND LENGKAP - TRANSFER UI (ADMIN PANEL V2.0)
// ================================================================

// --- KONFIGURASI ---
var TELEGRAM_BOT_TOKEN = "8238029335:AAFTyfRG9B5mZi04M_2feIr4_JxQ7X9pikM"; 
var CHAT_ID = "1441654753"; 
var SHEET_NAME = "Sheet1";      // Tab Data User Premium
var TRIAL_SHEET_NAME = "TrialUsers";
var ORDER_BOT_TOKEN = "7717843464:AAEu38flNxoQmP4p5Ku8lscgPJENV5z7ewQ"; 
var ORDER_CHAT_ID = "1441654753"; 
var CONFIG_SHEET_NAME = "Config"; 

// --- SECURITY: PASSWORD ADMIN ---
// Ganti "RAHASIA123" dengan password admin yang Anda inginkan!
// Simpan password ini di sini (Server Side), JANGAN di HTML.
var ADMIN_PASSWORD = "."; 

// ================================================================
// --- FUNGSI ADMIN API (HANDLE POST REQUEST DARI ADMIN PANEL) ---
// ================================================================
function handleAdminRequest(data) {
  
  // 1. Verifikasi Password Admin
  if (data.password !== ADMIN_PASSWORD) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error", 
      message: "Password Salah!"
    })).setMimeType(ContentService.MimeType.JSON);
  }

  // 2. Routing Aksi
  try {
    switch (data.subAction) {
      
      // --- MAINTENANCE ---
      case 'getMaintenance':
        return getMaintenanceStatus();
        
      case 'setMaintenance':
        return setMaintenanceStatus(data.status, data.reason);
        
      // --- USER MANAGEMENT ---
      case 'getAllUsers':
        return getAllUsers();
        
      case 'addUser':
        return addUser(data.token, data.expiry, data.limit);
        
      case 'editUser':
        return editUser(data.oldToken, data.newToken, data.expiry, data.limit, data.resetDevice);
        
      case 'deleteUser':
        return deleteUser(data.token);
        
      default:
        return ContentService.createTextOutput(JSON.stringify({
          status: "error", message: "Unknown Admin Action"
        })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error", message: "Server Error: " + e.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- FUNGSI MAINTENANCE ---
function getMaintenanceStatus() {
  var check = isSystemInMaintenance(); // Pakai fungsi helper yg sudah ada
  // Tapi kita butuh return JSON untuk Admin Panel
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    active: check.active,
    reason: check.message
  })).setMimeType(ContentService.MimeType.JSON);
}

function setMaintenanceStatus(status, reason) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
  
  if (!sheet) { // Buat sheet jika belum ada
    sheet = ss.insertSheet(CONFIG_SHEET_NAME);
    sheet.getRange("A1").setValue("STATUS MAINTENANCE (ON/OFF)");
    sheet.getRange("A2").setValue("PESAN MAINTENANCE");
  }
  
  sheet.getRange("B1").setValue(status); // "ON" atau "OFF"
  sheet.getRange("B2").setValue(reason);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    message: "Maintenance updated to " + status
  })).setMimeType(ContentService.MimeType.JSON);
}

// --- FUNGSI USER MANAGEMENT (SHEET1) ---
function getAllUsers() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Sheet User not found"})).setMimeType(ContentService.MimeType.JSON);
  
  // Ambil semua data (abaikan header baris 1)
  // Kolom: Token(A), Expired(B), DeviceId(C), MaxLimit(D), Used(E)
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    return ContentService.createTextOutput(JSON.stringify({status: "success", users: []})).setMimeType(ContentService.MimeType.JSON);
  }
  
  var data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
  var users = [];
  
  for (var i = 0; i < data.length; i++) {
    // Format tanggal expired agar terbaca mudah
    var expDate = "";
    if (data[i][1] instanceof Date) {
      expDate = Utilities.formatDate(data[i][1], "GMT+7", "yyyy-MM-dd");
    } else {
      expDate = String(data[i][1]); // jaga-jaga kalau string
    }
    
    users.push({
      token: data[i][0],
      expiry: expDate,
      deviceId: data[i][2],
      limit: data[i][3],
      used: data[i][4]
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success", 
    users: users
  })).setMimeType(ContentService.MimeType.JSON);
}

function addUser(token, expiry, limit) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  
  // Cek duplikat token
  var data = sheet.getDataRange().getValues();
  for (var i=0; i<data.length; i++) {
    if (data[i][0] == token) {
      return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Token sudah ada!"})).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  sheet.appendRow([token, expiry, "", limit, 0]); // Device ID kosong, Used 0
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success", message: "User berhasil ditambahkan"
  })).setMimeType(ContentService.MimeType.JSON);
}

function editUser(oldToken, newToken, expiry, limit, resetDevice) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  var found = false;
  
  for (var i = 1; i < data.length; i++) { // Skip header
    if (data[i][0] == oldToken) {
      // Update Data (Ingat index array 0, tapi row spreadsheet i+1)
      var row = i + 1;
      
      sheet.getRange(row, 1).setValue(newToken);
      sheet.getRange(row, 2).setValue(expiry);
      sheet.getRange(row, 4).setValue(limit);
      
      if (resetDevice) {
        sheet.getRange(row, 3).setValue(""); // Hapus Device ID
        // Opsional: Reset Used Count juga jika mau (sheet.getRange(row, 5).setValue(0);)
      }
      
      found = true;
      break;
    }
  }
  
  if (found) {
    return ContentService.createTextOutput(JSON.stringify({status: "success", message: "User berhasil diedit"})).setMimeType(ContentService.MimeType.JSON);
  } else {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Token lama tidak ditemukan"})).setMimeType(ContentService.MimeType.JSON);
  }
}

function deleteUser(token) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == token) {
      sheet.deleteRow(i + 1);
      return ContentService.createTextOutput(JSON.stringify({status: "success", message: "User dihapus"})).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({status: "error", message: "User tidak ditemukan"})).setMimeType(ContentService.MimeType.JSON);
}


// ================================================================
// --- FUNGSI EXISTING (GET, POST ORDER, TRIAL, MAINTENANCE) ---
// ================================================================

/**
 * UTAMA: Cek Status Maintenance
 */
function isSystemInMaintenance() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
    
    if (!sheet) {
      sheet = ss.insertSheet(CONFIG_SHEET_NAME);
      sheet.getRange("A1").setValue("STATUS MAINTENANCE (ON/OFF)").setFontWeight("bold");
      sheet.getRange("B1").setValue("OFF").setBackground("#ccffcc"); 
      sheet.getRange("A2").setValue("PESAN MAINTENANCE").setFontWeight("bold");
      sheet.getRange("B2").setValue("Sistem sedang dalam perbaikan rutin.");
      return { active: false, message: "" };
    }
    
    var status = sheet.getRange("B1").getValue().toString().toUpperCase().trim();
    var customMsg = sheet.getRange("B2").getValue();
    if (customMsg === "") customMsg = "Sistem sedang dalam perbaikan rutin.";
    
    if (status === "ON") {
      return { active: true, message: customMsg };
    }
    return { active: false, message: "" };
  } catch (e) {
    return { active: false, message: "" };
  }
}

function sendTelegramNotification(message) {
  var url = "https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage";
  try {
    UrlFetchApp.fetch(url, {method: "post", payload: {chat_id: String(CHAT_ID), text: message, parse_mode: "HTML"}});
  } catch (e) {}
}

function handleTrialLogic(deviceId) {
  var lock = LockService.getScriptLock();
  if (!lock.tryLock(15000)) return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "Server sibuk." })).setMimeType(ContentService.MimeType.JSON);
  
  try { 
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var trialSheet = ss.getSheetByName(TRIAL_SHEET_NAME);
    if (!trialSheet) { trialSheet = ss.insertSheet(TRIAL_SHEET_NAME); trialSheet.getRange("A1:E1").setValues([["DeviceId", "LoginCount", "MaxLimit", 2, "Default"]]); }
    
    var data = trialSheet.getDataRange().getValues();
    var defaultTrialLimit = 2; 
    if (data.length > 0 && data[0][3]) defaultTrialLimit = parseInt(data[0][3], 10);
    
    var userRow = -1, loginCount = 0, maxLimit = 0;
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] == deviceId) { userRow = i + 1; loginCount = parseInt(data[i][1], 10)||0; maxLimit = parseInt(data[i][2], 10)||0; break; }
    }
    
    var result = {};
    if (userRow === -1) { 
      var sisa = Math.max(0, defaultTrialLimit - 1);
      trialSheet.appendRow([deviceId, 1, defaultTrialLimit]);
      result = { status: "success", message: "Trial sisa " + sisa + "x.", expiryDate: "Trial", remainingLogins: sisa };
      sendTelegramNotification("üöÄ TRIAL BARU\n<b>Device:</b> " + deviceId);
    } else if (loginCount < maxLimit) { 
      var sisa = maxLimit - (loginCount + 1);
      trialSheet.getRange(userRow, 2).setValue(loginCount + 1);
      result = { status: "success", message: "Trial sisa " + sisa + "x.", expiryDate: "Trial", remainingLogins: sisa };
      sendTelegramNotification("üöÄ TRIAL ULANG\n<b>Device:</b> " + deviceId);
    } else { 
      result = { status: "error", message: "Masa trial habis." };
      sendTelegramNotification("‚ùå TRIAL HABIS\n<b>Device:</b> " + deviceId);
    }
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "Error: " + e.message })).setMimeType(ContentService.MimeType.JSON);
  } finally { lock.releaseLock(); }
}

function doGet(e) {
  var maintCheck = isSystemInMaintenance();
  if (maintCheck.active) return ContentService.createTextOutput(JSON.stringify({status: "maintenance", message: maintCheck.message})).setMimeType(ContentService.MimeType.JSON);

  var token = e.parameter.token;
  var deviceId = e.parameter.deviceId; 
  
  if (token === "TRIAL_REQUEST") {
    if (!deviceId) return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "No DeviceId" })).setMimeType(ContentService.MimeType.JSON);
    return handleTrialLogic(deviceId);
  }
  
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  var dataRange = sheet.getRange(1, 1, sheet.getLastRow(), 5); 
  var values = dataRange.getValues();
  var result = { status: "error", message: "Token tidak ditemukan" };
  var today = new Date(); today.setHours(0, 0, 0, 0); 

  for (var i = 0; i < values.length; i++) {
    if (values[i][0] == token) {
      var lock = LockService.getScriptLock();
      if (!lock.tryLock(15000)) { result.status = "error"; result.message = "Server sibuk."; break; }
      
      try {
        var rowData = sheet.getRange(i + 1, 1, 1, 5).getValues()[0];
        var expiryDate = new Date(rowData[1]); expiryDate.setHours(0, 0, 0, 0);
        var storedDeviceId = rowData[2];
        var loginLimit = rowData[3];
        var loginCount = rowData[4];
        
        if (expiryDate < today) {
          result.status = "error"; result.message = "Token Kadaluwarsa";
        } else if (typeof loginLimit === 'number' && loginLimit > 0 && loginCount >= loginLimit) {
          result.status = "error"; result.message = "Batas Login Habis";
        } else if (storedDeviceId == "" || storedDeviceId == deviceId) {
          var newCount = (typeof loginCount === 'number' ? loginCount : 0) + 1;
          if (storedDeviceId == "") sheet.getRange(i + 1, 3).setValue(deviceId); 
          sheet.getRange(i + 1, 5).setValue(newCount); 
          
          result.status = "success"; result.message = "Token Valid";
          result.expiryDate = Utilities.formatDate(expiryDate, "GMT+7", "dd MMMM yyyy");
          result.remainingLogins = (typeof loginLimit === 'number' && loginLimit > 0) ? (loginLimit - newCount) : "Unlimited";
          sendTelegramNotification("‚úÖ LOGIN SUKSES\n<b>Token:</b> " + token);
        } else {
          result.status = "error"; result.message = "Token terkunci di device lain.";
          sendTelegramNotification("‚ùå LOGIN GAGAL (Device Beda)\n<b>Token:</b> " + token);
        }
      } catch (e) { result.status = "error"; result.message = "Error: " + e.message; }
      finally { lock.releaseLock(); }
      break;
    }
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  // ROUTING POST REQUEST
  // Jika ada parameter 'action=admin', arahkan ke handler Admin
  // Jika 'action=submitOrder', arahkan ke order
  
  try {
    var data = JSON.parse(e.postData.contents);
    
    // --- CEK MAINTENANCE UNTUK USER BIASA (Kecuali Admin) ---
    // Admin tetap harus bisa akses meski maintenance ON
    if (data.action !== 'admin') {
      var maintCheck = isSystemInMaintenance();
      if (maintCheck.active) {
        return ContentService.createTextOutput(JSON.stringify({status: "maintenance", message: maintCheck.message})).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // HANDLER
    if (data.action === 'admin') {
      return handleAdminRequest(data);
    } else if (data.action === 'submitOrder') {
      return handleOrderSubmit(data);
    }
    
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Unknown Action"})).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Error POST: " + error.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleOrderSubmit(data) {
  var caption = "<b>üîî ORDER TOKEN BARU</b>\n\n<b>Device ID:</b> <code>" + data.deviceId + "</code>\n";
  var cleanNumber = String(data.whatsapp).trim().replace(/[^0-9]/g, ''); 
  if (cleanNumber.startsWith('0')) cleanNumber = '62' + cleanNumber.substring(1);
  caption += "<b>WA:</b> <a href='https://wa.me/" + cleanNumber + "'>" + data.whatsapp + "</a>\n";
  caption += "<b>Paket:</b> " + data.tier + " | <b>Harga:</b> " + data.price;
  
  var imageBlob = Utilities.newBlob(Utilities.base64Decode(data.image.split(',')[1]), 'image/png', 'bukti.png'); 
  try {
    UrlFetchApp.fetch("https://api.telegram.org/bot" + ORDER_BOT_TOKEN + "/sendPhoto", {
      'method': 'post',
      'payload': { 'chat_id': String(ORDER_CHAT_ID), 'caption': caption, 'parse_mode': 'HTML', 'photo': imageBlob }
    });
    return ContentService.createTextOutput(JSON.stringify({status: "success", message: "Order terkirim"})).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Gagal kirim: " + err.message})).setMimeType(ContentService.MimeType.JSON);
  }
}
