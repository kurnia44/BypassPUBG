// ================================================================
// KODE BACKEND FINAL - TRANSFER UI (PASSWORD VIA SPREADSHEET)
// ================================================================

// --- KONFIGURASI ---
var TELEGRAM_BOT_TOKEN = "8238029335:AAFTyfRG9B5mZi04M_2feIr4_JxQ7X9pikM"; 
var CHAT_ID = "1441654753"; 
var SHEET_NAME = "Sheet1";      
var TRIAL_SHEET_NAME = "TrialUsers";
var ORDER_BOT_TOKEN = "7717843464:AAEu38flNxoQmP4p5Ku8lscgPJENV5z7ewQ"; 
var ORDER_CHAT_ID = "1441654753"; 
var CONFIG_SHEET_NAME = "Config"; 

// ================================================================
// --- FUNGSI ADMIN API ---
// ================================================================
function handleAdminRequest(data) {
  
  // 1. AMBIL PASSWORD DARI SPREADSHEET (Cell B3)
  var realPassword = getPasswordFromSheet();
  
  // 2. Verifikasi Password
  // Kita paksa jadi String agar perbandingan aman
  if (String(data.password) !== String(realPassword)) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error", 
      message: "Password Salah!"
    })).setMimeType(ContentService.MimeType.JSON);
  }

  // 3. Routing Aksi
  try {
    switch (data.subAction) {
      case 'getMaintenance': return getMaintenanceStatus();
      case 'setMaintenance': return setMaintenanceStatus(data.status, data.reason);
      case 'getAllUsers': return getAllUsers();
      case 'addUser': return addUser(data.token, data.expiry, data.limit);
      case 'editUser': return editUser(data.oldToken, data.newToken, data.expiry, data.limit, data.resetDevice);
      case 'deleteUser': return deleteUser(data.token);
      default:
        return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Unknown Admin Action"})).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Server Error: " + e.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- FUNGSI BANTUAN: BACA PASSWORD ---
function getPasswordFromSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
  if (!sheet) return "admin123"; // Fallback jika sheet hilang
  
  // Ambil data dari B3
  var pass = sheet.getRange("B3").getValue();
  return pass;
}

// --- FUNGSI MAINTENANCE ---
function getMaintenanceStatus() {
  var check = isSystemInMaintenance(); 
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    active: check.active,
    reason: check.message
  })).setMimeType(ContentService.MimeType.JSON);
}

function setMaintenanceStatus(status, reason) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
  
  if (!sheet) { 
    sheet = ss.insertSheet(CONFIG_SHEET_NAME);
    setupConfigSheet(sheet);
  }
  
  sheet.getRange("B1").setValue(status); 
  sheet.getRange("B2").setValue(reason);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    message: "Maintenance updated to " + status
  })).setMimeType(ContentService.MimeType.JSON);
}

// --- FUNGSI USER MANAGEMENT ---
function getAllUsers() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Sheet User not found"})).setMimeType(ContentService.MimeType.JSON);
  
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return ContentService.createTextOutput(JSON.stringify({status: "success", users: []})).setMimeType(ContentService.MimeType.JSON);
  
  var data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
  var users = [];
  
  for (var i = 0; i < data.length; i++) {
    var expDate = (data[i][1] instanceof Date) ? Utilities.formatDate(data[i][1], "GMT+7", "yyyy-MM-dd") : String(data[i][1]);
    users.push({ token: data[i][0], expiry: expDate, deviceId: data[i][2], limit: data[i][3], used: data[i][4] });
  }
  return ContentService.createTextOutput(JSON.stringify({status: "success", users: users})).setMimeType(ContentService.MimeType.JSON);
}

function addUser(token, expiry, limit) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  for (var i=0; i<data.length; i++) {
    if (data[i][0] == token) return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Token sudah ada!"})).setMimeType(ContentService.MimeType.JSON);
  }
  sheet.appendRow([token, expiry, "", limit, 0]);
  return ContentService.createTextOutput(JSON.stringify({status: "success", message: "User berhasil ditambahkan"})).setMimeType(ContentService.MimeType.JSON);
}

function editUser(oldToken, newToken, expiry, limit, resetDevice) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  var found = false;
  for (var i = 1; i < data.length; i++) { 
    if (data[i][0] == oldToken) {
      var row = i + 1;
      sheet.getRange(row, 1).setValue(newToken);
      sheet.getRange(row, 2).setValue(expiry);
      sheet.getRange(row, 4).setValue(limit);
      if (resetDevice) sheet.getRange(row, 3).setValue(""); 
      found = true; break;
    }
  }
  if (found) return ContentService.createTextOutput(JSON.stringify({status: "success", message: "User berhasil diedit"})).setMimeType(ContentService.MimeType.JSON);
  return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Token lama tidak ditemukan"})).setMimeType(ContentService.MimeType.JSON);
}

function deleteUser(token) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == token) {
      sheet.deleteRow(i + 1);
      return ContentService.createTextOutput(JSON.stringify({status: "success", message: "User dihapus"})).setMimeType(ContentService.MimeType.JSON);
    }
  }
  return ContentService.createTextOutput(JSON.stringify({status: "error", message: "User tidak ditemukan"})).setMimeType(ContentService.MimeType.JSON);
}

// ================================================================
// --- FUNGSI UMUM (DO GET & DO POST) ---
// ================================================================

function isSystemInMaintenance() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(CONFIG_SHEET_NAME);
      setupConfigSheet(sheet);
      return { active: false, message: "" };
    }
    var status = sheet.getRange("B1").getValue().toString().toUpperCase().trim();
    var customMsg = sheet.getRange("B2").getValue();
    if (customMsg === "") customMsg = "Sistem sedang dalam perbaikan rutin.";
    if (status === "ON") return { active: true, message: customMsg };
    return { active: false, message: "" };
  } catch (e) { return { active: false, message: "" }; }
}

function setupConfigSheet(sheet) {
  sheet.getRange("A1").setValue("STATUS MAINTENANCE (ON/OFF)").setFontWeight("bold");
  sheet.getRange("B1").setValue("OFF").setBackground("#ccffcc"); 
  sheet.getRange("A2").setValue("PESAN MAINTENANCE").setFontWeight("bold");
  sheet.getRange("B2").setValue("Sistem sedang perbaikan.");
  sheet.getRange("A3").setValue("ADMIN PASSWORD").setFontWeight("bold");
  sheet.getRange("B3").setValue("admin123"); // Default Password
}

function sendTelegramNotification(message) {
  try {
    UrlFetchApp.fetch("https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage", {method: "post", payload: {chat_id: String(CHAT_ID), text: message, parse_mode: "HTML"}});
  } catch (e) {}
}

function doGet(e) {
  var maintCheck = isSystemInMaintenance();
  if (maintCheck.active) return ContentService.createTextOutput(JSON.stringify({status: "maintenance", message: maintCheck.message})).setMimeType(ContentService.MimeType.JSON);

  var token = e.parameter.token;
  var deviceId = e.parameter.deviceId; 
  
  if (token === "TRIAL_REQUEST") {
    // Logika Trial (Disederhanakan untuk ringkas, copy logika full jika perlu)
     var lock = LockService.getScriptLock();
     if (!lock.tryLock(15000)) return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "Server sibuk." })).setMimeType(ContentService.MimeType.JSON);
     try {
        var ss = SpreadsheetApp.getActiveSpreadsheet();
        var tSheet = ss.getSheetByName(TRIAL_SHEET_NAME);
        if(!tSheet) { tSheet = ss.insertSheet(TRIAL_SHEET_NAME); tSheet.appendRow(["DeviceId","Count","Limit"]); }
        // Simple Trial Check
        var data = tSheet.getDataRange().getValues();
        var found = false, limit=2, count=0;
        for(var i=1; i<data.length; i++){
            if(data[i][0]==deviceId){ found=true; count=data[i][1]; limit=data[i][2]; 
              if(count<limit) { tSheet.getRange(i+1,2).setValue(count+1); return ContentService.createTextOutput(JSON.stringify({status:"success", remainingLogins: limit-(count+1)})).setMimeType(ContentService.MimeType.JSON); }
              else return ContentService.createTextOutput(JSON.stringify({status:"error", message:"Trial Habis"})).setMimeType(ContentService.MimeType.JSON);
            }
        }
        if(!found){ tSheet.appendRow([deviceId, 1, 2]); return ContentService.createTextOutput(JSON.stringify({status:"success", remainingLogins: 1})).setMimeType(ContentService.MimeType.JSON); }
     } finally { lock.releaseLock(); }
  }
  
  // LOGIKA LOGIN PREMIUM
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  var dataRange = sheet.getRange(1, 1, sheet.getLastRow(), 5); 
  var values = dataRange.getValues();
  var result = { status: "error", message: "Token tidak ditemukan" };
  var today = new Date(); today.setHours(0, 0, 0, 0); 

  for (var i = 0; i < values.length; i++) {
    if (values[i][0] == token) {
      var rowData = values[i];
      var expiryDate = new Date(rowData[1]); expiryDate.setHours(0, 0, 0, 0);
      var storedDeviceId = rowData[2];
      var loginLimit = rowData[3];
      var loginCount = rowData[4];
      
      if (expiryDate < today) { result.status="error"; result.message="Token Kadaluwarsa"; }
      else if (loginLimit && loginCount >= loginLimit) { result.status="error"; result.message="Limit Habis"; }
      else if (storedDeviceId == "" || storedDeviceId == deviceId) {
         sheet.getRange(i+1, 5).setValue(loginCount+1);
         if(storedDeviceId=="") sheet.getRange(i+1, 3).setValue(deviceId);
         result.status="success"; result.message="Valid"; result.expiryDate = Utilities.formatDate(expiryDate, "GMT+7", "dd MMM yyyy");
         result.remainingLogins = loginLimit ? (loginLimit-(loginCount+1)) : "Unlimited";
         sendTelegramNotification("âœ… LOGIN: " + token);
      } else { result.status="error"; result.message="Device Terkunci"; }
      break;
    }
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    if (data.action !== 'admin') {
      var maintCheck = isSystemInMaintenance();
      if (maintCheck.active) return ContentService.createTextOutput(JSON.stringify({status: "maintenance", message: maintCheck.message})).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (data.action === 'admin') return handleAdminRequest(data);
    else if (data.action === 'submitOrder') return handleOrderSubmit(data);
    
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Unknown Action"})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Error POST: " + error.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleOrderSubmit(data) {
  var caption = "ðŸ”” ORDER\nID: " + data.deviceId + "\nWA: " + data.whatsapp + "\nPaket: " + data.tier;
  var imageBlob = Utilities.newBlob(Utilities.base64Decode(data.image.split(',')[1]), 'image/png', 'bukti.png'); 
  try {
    UrlFetchApp.fetch("https://api.telegram.org/bot" + ORDER_BOT_TOKEN + "/sendPhoto", {
      'method': 'post',
      'payload': { 'chat_id': String(ORDER_CHAT_ID), 'caption': caption, 'photo': imageBlob }
    });
    return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
  } catch (e) { return ContentService.createTextOutput(JSON.stringify({status: "error"})).setMimeType(ContentService.MimeType.JSON); }
}
