// --- KONFIGURASI ---
// 1. Token Bot VALIDASI (Bot Anda yang lama)
var TELEGRAM_BOT_TOKEN = "8238029335:AAFTyfRG9B5mZi04M_2feIr4_JxQ7X9pikM"; 

// 2. Chat ID VALIDASI (Chat ID Anda yang lama)
var CHAT_ID = "1441654753"; 

// 3. Nama Sheet Validasi
var SHEET_NAME = "Sheet1";

// 4. Nama Sheet Trial
var TRIAL_SHEET_NAME = "TrialUsers";

// 5. Token Bot ORDER (Bot BARU Anda)
var ORDER_BOT_TOKEN = "7717843464:AAEu38flNxoQmP4p5Ku8lscgPJENV5z7ewQ"; 

// 6. Chat ID ADMIN untuk ORDER
var ORDER_CHAT_ID = "1441654753"; 

// 7. Nama Sheet Konfigurasi (UNTUK MAINTENANCE)
var CONFIG_SHEET_NAME = "Config"; 
// ------------------------------------------

/**
 * FUNGSI BARU: Cek Status Maintenance dari Spreadsheet
 */
function isSystemInMaintenance() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
    
    // Jika sheet Config belum ada, buat otomatis
    if (!sheet) {
      sheet = ss.insertSheet(CONFIG_SHEET_NAME);
      sheet.getRange("A1").setValue("STATUS MAINTENANCE (ON/OFF)");
      sheet.getRange("B1").setValue("OFF"); // Default mati (Aplikasi Jalan)
      sheet.getRange("A1").setFontWeight("bold");
      sheet.getRange("B1").setBackground("#ccffcc"); // Hijau = Aman
      return false;
    }
    
    // Baca status dari sel B1
    var status = sheet.getRange("B1").getValue().toString().toUpperCase().trim();
    
    if (status === "ON") {
      return true; // Mode Maintenance Aktif
    }
    return false; // Mode Normal
  } catch (e) {
    Logger.log("Gagal cek maintenance: " + e.message);
    return false; // Jika error baca sheet, anggap normal agar tidak down
  }
}

/**
 * Fungsi untuk mengirim notifikasi ke Telegram (Validasi)
 */
function sendTelegramNotification(message) {
  var url = "https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage";
  var payload = {
    method: "post",
    payload: {
      chat_id: String(CHAT_ID),
      text: message,
      parse_mode: "HTML"
    }
  };

  try {
    UrlFetchApp.fetch(url, payload);
  } catch (e) {
    Logger.log("Gagal mengirim notifikasi Telegram: " + e);
  }
}

// ================================================================
// --- FUNGSI LOGIKA TRIAL ---
// ================================================================
function handleTrialLogic(deviceId) {
  var lock = LockService.getScriptLock();
  var lockAcquired = false;
  
  try { 
    lockAcquired = lock.tryLock(15000); 
    if (!lockAcquired) {
      var busyResult = { status: "error", message: "Server sibuk. Coba lagi." };
      return ContentService.createTextOutput(JSON.stringify(busyResult)).setMimeType(ContentService.MimeType.JSON);
    }
    
    try { 
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var trialSheet = ss.getSheetByName(TRIAL_SHEET_NAME);
      if (!trialSheet) {
        trialSheet = ss.insertSheet(TRIAL_SHEET_NAME);
        trialSheet.getRange("A1:E1").setValues([["DeviceId", "LoginCount", "MaxLimit", 2, "Default"]]); 
      }
      var data = trialSheet.getDataRange().getValues();
      var defaultTrialLimit = 2; 
      if (data.length > 0 && data[0][3]) defaultTrialLimit = parseInt(data[0][3], 10);
      
      var userRow = -1; 
      var loginCount = 0;
      var maxLimitForThisUser = 0; 
      for (var i = 1; i < data.length; i++) {
        if (data[i][0] == deviceId) { 
          userRow = i + 1; 
          loginCount = parseInt(data[i][1], 10) || 0; 
          maxLimitForThisUser = parseInt(data[i][2], 10) || 0; 
          break;
        }
      }
      var result = {};
      
      if (userRow === -1) { // User Baru
        var newLoginCount = 1;
        maxLimitForThisUser = defaultTrialLimit; 
        trialSheet.appendRow([deviceId, newLoginCount, maxLimitForThisUser]);
        var sisaTrial = Math.max(0, maxLimitForThisUser - newLoginCount);
        result = { status: "success", message: "Trial sisa " + sisaTrial + "x.", expiryDate: "Trial", remainingLogins: sisaTrial };
        sendTelegramNotification("üöÄ TRIAL BARU\n<b>Device:</b> " + deviceId + "\n<b>Sisa:</b> " + sisaTrial);

      } else if (loginCount < maxLimitForThisUser) { // User Lama Masih Ada Kuota
        var newLoginCount = loginCount + 1;
        trialSheet.getRange(userRow, 2).setValue(newLoginCount);
        var sisaTrial = maxLimitForThisUser - newLoginCount;
        result = { status: "success", message: "Trial sisa " + sisaTrial + "x.", expiryDate: "Trial", remainingLogins: sisaTrial };
        sendTelegramNotification("üöÄ TRIAL ULANG\n<b>Device:</b> " + deviceId + "\n<b>Sisa:</b> " + sisaTrial);

      } else { // Habis
        result = { status: "error", message: "Masa trial habis." };
        sendTelegramNotification("‚ùå TRIAL HABIS\n<b>Device:</b> " + deviceId);
      }
      return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
    
    } catch (e) {
      var errorResult = { status: "error", message: "Error Server Trial: " + e.message };
      return ContentService.createTextOutput(JSON.stringify(errorResult)).setMimeType(ContentService.MimeType.JSON);
    }

  } finally {
    if (lockAcquired) lock.releaseLock();
  }
}

/**
 * Fungsi doGet (Validasi Token) - SUDAH ADA CEK MAINTENANCE
 */
function doGet(e) {
  // --- 1. CEK MAINTENANCE MODE ---
  if (isSystemInMaintenance()) {
    var maintResult = {
      status: "maintenance",
      message: "Sistem sedang dalam perbaikan (Maintenance). Silakan coba lagi nanti."
    };
    return ContentService.createTextOutput(JSON.stringify(maintResult))
      .setMimeType(ContentService.MimeType.JSON);
  }
  // -------------------------------

  var token = e.parameter.token;
  var deviceId = e.parameter.deviceId; 
  
  if (token === "TRIAL_REQUEST") {
    if (!deviceId) return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "No DeviceId" })).setMimeType(ContentService.MimeType.JSON);
    return handleTrialLogic(deviceId);
  }
  
  // Logika Validasi Token
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  var dataRange = sheet.getRange(1, 1, sheet.getLastRow(), 5); 
  var values = dataRange.getValues();
  var result = { status: "error", message: "Token tidak ditemukan" };
  var today = new Date();
  today.setHours(0, 0, 0, 0); 
  var tokenFound = false;

  for (var i = 0; i < values.length; i++) {
    if (values[i][0] == token) {
      tokenFound = true;
      var lock = LockService.getScriptLock();
      var lockAcquired = false;
      
      try {
        lockAcquired = lock.tryLock(15000);
        if (!lockAcquired) {
          result.status = "error"; result.message = "Server sibuk."; break;
        }
        
        var rowData = sheet.getRange(i + 1, 1, 1, 5).getValues()[0];
        var expiryDate = new Date(rowData[1]);
        var storedDeviceId = rowData[2];
        var loginLimit = rowData[3];
        var loginCount = rowData[4];
        
        expiryDate.setHours(0, 0, 0, 0);
        
        if (expiryDate < today) {
          result.status = "error"; result.message = "Token Kadaluwarsa";
        } else if (typeof loginLimit === 'number' && loginLimit > 0 && loginCount >= loginLimit) {
          result.status = "error"; result.message = "Batas Login Habis";
        } else if (storedDeviceId == "" || storedDeviceId == deviceId) {
          // Sukses
          var newCount = (typeof loginCount === 'number' ? loginCount : 0) + 1;
          if (storedDeviceId == "") sheet.getRange(i + 1, 3).setValue(deviceId); // Kunci Device
          sheet.getRange(i + 1, 5).setValue(newCount); // Tambah count
          
          result.status = "success";
          result.message = "Token Valid";
          var formattedExpiry = Utilities.formatDate(expiryDate, "GMT+7", "dd MMMM yyyy");
          result.expiryDate = formattedExpiry;
          result.remainingLogins = (typeof loginLimit === 'number' && loginLimit > 0) ? (loginLimit - newCount) : "Unlimited";
          
          sendTelegramNotification("‚úÖ LOGIN SUKSES\n<b>Token:</b> " + token + "\n<b>Sisa:</b> " + result.remainingLogins);
        } else {
          result.status = "error"; result.message = "Token terkunci di device lain.";
          sendTelegramNotification("‚ùå LOGIN GAGAL (Device Beda)\n<b>Token:</b> " + token);
        }

      } catch (e) {
          result.status = "error"; result.message = "Error: " + e.message;
      } finally {
          if (lockAcquired) lock.releaseLock();
      }
      break;
    }
  }

  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Fungsi doPost (Order Foto) - SUDAH ADA CEK MAINTENANCE
 */
function doPost(e) {
  // --- 1. CEK MAINTENANCE MODE ---
  if (isSystemInMaintenance()) {
    var maintResult = {
      status: "maintenance",
      message: "Sistem sedang dalam perbaikan. Order tidak dapat dilakukan saat ini."
    };
    return ContentService.createTextOutput(JSON.stringify(maintResult))
      .setMimeType(ContentService.MimeType.JSON);
  }
  // -------------------------------

  try {
    var data = JSON.parse(e.postData.contents);
    if (data.action === 'submitOrder') {
      return handleOrderSubmit(data);
    }
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Unknown Action"})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Error POST: " + error.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleOrderSubmit(data) {
  var botToken = ORDER_BOT_TOKEN; 
  var chatId = ORDER_CHAT_ID;     
  var telegramUrl = "https://api.telegram.org/bot" + botToken + "/sendPhoto";

  var caption = "<b>üîî ORDER TOKEN BARU</b>\n\n<b>Device ID:</b> <code>" + data.deviceId + "</code>\n";
  var cleanNumber = String(data.whatsapp).trim().replace(/[^0-9]/g, ''); 
  if (cleanNumber.startsWith('0')) cleanNumber = '62' + cleanNumber.substring(1);
  
  caption += "<b>WA:</b> <a href='https://wa.me/" + cleanNumber + "'>" + data.whatsapp + "</a>\n";
  caption += "<b>Paket:</b> " + data.tier + " | <b>Harga:</b> " + data.price;
  
  var imageBlob = Utilities.newBlob(Utilities.base64Decode(data.image.split(',')[1]), 'image/png', 'bukti.png'); 

  try {
    UrlFetchApp.fetch(telegramUrl, {
      'method': 'post',
      'payload': { 'chat_id': String(chatId), 'caption': caption, 'parse_mode': 'HTML', 'photo': imageBlob }
    });
    return ContentService.createTextOutput(JSON.stringify({status: "success", message: "Order terkirim"})).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Gagal kirim: " + err.message})).setMimeType(ContentService.MimeType.JSON);
  }
}
